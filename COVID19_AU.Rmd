---
title: "COVID-19 Progression: Australian Data Only"
date: "`r paste('Last Updated:', format(Sys.time(), '%d-%B-%Y %H:%M'), '(UTC+9:30)')`"
output: 
  html_document: 
    code_folding: hide
    toc: yes
    toc_depth: 2
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
    echo = TRUE,
    message = FALSE, warning = FALSE,
    fig.align = "center"
)
```

```{r packages}
library(tidyverse)
library(magrittr)
library(lubridate)
library(scales)
library(matrixStats)
library(ggrepel)
library(broom)
library(glue)
library(jsonlite)
library(rvest)
library(RCurl)
library(pander)
library(plotly)
library(cowplot)
library(QuantTools)
library(ggfortify)
library(readxl)
panderOptions("big.mark", ",")
panderOptions("table.split.table", Inf)
panderOptions("table.style", "rmarkdown")
panderOptions("missing", "")
theme_set(theme_bw())
```


```{r shiftAxisLabel}
shiftAxisLabel <- function(x, k = 2){
  x$x$layout$annotations[[2]]$x <- x$x$layout$annotations[[2]]$x*k
  x$x$layout$margin$l <- x$x$layout$margin$l*k
  x
}
```



```{r dt}
# Handle updates between 12am & 12pm
dt <- Sys.Date()
if (as.numeric(format(Sys.time(), "%H")) < 12){
  dt <- Sys.Date() - 1
}
```

```{r ausStates}
auStates <- c(
  ACT = "Australian Capital Territory",
  QLD = "Queensland",
  NSW = "New South Wales",
  VIC = "Victoria",
  SA = "South Australia",
  WA = "Western Australia",
  NT = "Northern Territory",
  TAS = "Tasmania"
)
```



# Data Sources


```{r confirmed}
confirmed <- url("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv") %>%
    read_csv() %>%
    pivot_longer(
        cols = ends_with("20"),
        names_to = "date",
        values_to = "confirmed"
    )  %>%
    mutate(
        date = str_replace_all(
            date, "(.+)/(.+)/(.+)", "20\\3-\\1-\\2"
        ) %>%
            ymd()
    ) %>%
    dplyr::rename(
        Country = `Country/Region`
    ) %>%
    dplyr::filter(
        !is.na(confirmed),
        Country == "Australia"
    ) %>%
  dplyr::select(-Lat, -Long)
```

```{r guardData}
guardData <- fromJSON("https://interactive.guim.co.uk/docsdata/1q5gdePANXci8enuiS4oHUJxcxC13d6bjMRSicakychE.json")
altAU <- guardData$sheets$updates %>% 
  as_tibble() %>% 
  mutate(
    `Province/State` = auStates[State], 
    Country = "Australia", 
    Date = parse_date_time(Date, orders = "%d/%m/%Y") %>% ymd()
  ) %>% 
  dplyr::select(`Province/State`, Country, date = Date, confirmed = `Cumulative case count`) %>% 
  mutate(confirmed = as.numeric(confirmed)) %>%
  arrange(`Province/State`, date) %>%
  tidyr::complete(`Province/State`, Country, date) %>%
  group_by(`Province/State`) %>%
  fill(confirmed)  %>%
  dplyr::filter(!is.na(confirmed))  %>%
  ungroup()
# Add the data, with the Guardian API being preferentialy selected
confirmed %<>%
  mutate(source = "JHU") %>%
  bind_rows(
    mutate(altAU, source = "API")
  ) %>%
  arrange(
    date, `Province/State`, source
  ) %>%
  distinct(`Province/State`, Country, date, .keep_all = TRUE) %>%
  dplyr::select(-source)
```


```{r initLatestAU}
latestAU <- list()
```


```{r updateNSW}
nswRecov <- nswTests <- NA_real_
nswUrl <- "https://www.health.nsw.gov.au/_layouts/feed.aspx?xsl=1&web=/news&page=4ac47e14-04a9-4016-b501-65a23280e841&wp=baabf81e-a904-44f1-8d59-5f6d56519965&pageurl=/news/Pages/rss-nsw-health.aspx" %>%
  read_xml() %>%
  xml_find_all("//item") %>%
  .[[1]] %>%
  as.character() %>%
  str_split("\n") %>%
  .[[1]] %>%
  str_subset("https") %>%
  str_extract("https[^<]+")
nswTable <- nswUrl %>%
  read_html() %>%
  html_nodes("body") %>%
  xml_find_all("//table") %>%
  .[[1]] %>%
  html_table() %>%
  # set_colnames(
     # str_replace_all(colnames(.), "\\u200b", "")
  # ) %>%
  set_colnames(
    c("Cases", "Count")
  ) %>%
  mutate_all(str_replace_all, pattern = "\\u200b", replacement = "") %>%
  mutate(
    Count = str_remove_all(Count, "[\\*,]") %>% as.numeric,
    Cases = str_replace_all(Cases, " +", " ")
  )
nswTests <- nswTable %>%
  dplyr::filter(
    str_detect(Cases, "Total tests carried out")
  ) %>%
  .[["Count"]]
nswRecov <- nswTable %>%
  dplyr::filter(str_detect(Cases, "recovered")) %>%
  .[["Count"]]
latestAU$NSW <- tibble(
  State = "New South Wales",
  date = dt,
  confirmed = nswTable %>%
    dplyr::filter(str_detect(Cases, "Confirmed cases")) %>%
    .[["Count"]],
  deaths = nswTable %>%
    dplyr::filter(str_detect(Cases, "Deaths")) %>%
    .[["Count"]],
  recovered = nswRecov,
  tested = nswTests
)
```

```{r updateQLD, eval=FALSE, echo=FALSE}
qldRecov <- qldTests <- NA_real_
qldUrl <- "https://www.qld.gov.au/health/conditions/health-alerts/coronavirus-covid-19/current-status/statistics"
qldTests <- qldUrl %>%
  read_html() %>%
  html_nodes("body") %>%
  xml_find_all("//div[contains(@class, 'tested')]") %>%
  html_text() %>%
  str_extract("[0-9,]+") %>%
  str_remove_all(",") %>%
  as.numeric()
qldTable <- qldUrl %>%
  read_html() %>%
  html_nodes("body") %>%
  xml_find_all("//table[@id = 'QLD_Cases']") %>%
  html_table() %>%
  .[[1]] 
qldConfirmed <-  qldTable %>%
  dplyr::filter(str_detect(Cases, "Number of cases")) %>%
  pull(Total) %>%
  str_remove_all(",") %>%
  as.numeric()
qldActive <- qldTable %>%
  dplyr::filter(str_detect(Cases, "Active")) %>%
  pull(Total) %>%
  as.numeric()
qldDeaths <-  qldTable %>%
  dplyr::filter(str_detect(Cases, "Deaths")) %>%
  pull(Total) %>%
  as.numeric()
# qldRecov <- qldTable %>%
#   dplyr::filter(Cases == "Recovered") %>%
#   .[["Total"]] %>%
#   str_remove_all(",") %>%
#   as.numeric()
qldRecov <- qldConfirmed - qldActive - qldDeaths
latestAU$QLD <- tibble(
  State = "Queensland",
  date = dt,
  confirmed = qldConfirmed,
  deaths = qldDeaths,
  recovered = qldRecov,
  tested = qldTests
)
```


```{r altQld}
qldUrl <- "https://covidlive.com.au/qld" 
qldBody <- qldUrl %>% 
    read_html() %>% 
    html_nodes("body") 
qldTable <- qldBody %>%
    xml_find_all("//table[contains(@class, 'DAILY-SUMMARY')]") %>% 
    html_table() %>%
    .[[1]] %>% 
    mutate(
        TOTAL = str_remove_all(TOTAL, ",") %>% as.numeric
    )
latestAU$QLD <- tibble(
  State = "Queensland",
  date = dt,
  confirmed = qldTable %>%
      dplyr::filter(COUNT == "Cases") %>%
      pull(TOTAL),
  deaths =  qldTable %>%
      dplyr::filter(COUNT == "Deaths") %>%
      pull(TOTAL),
  recovered =  qldTable %>%
      dplyr::filter(COUNT == "Recoveries") %>%
      pull(TOTAL),
  tested = qldBody %>% 
      xml_find_all("//table[contains(@class, 'DAILY-TESTS')]") %>%
      html_table() %>% 
      .[[1]] %>% 
      mutate(TESTS = str_remove_all(TESTS, ",") %>% as.numeric) %>% 
      pull(TESTS) %>%
      max()
)
```


```{r updateVic, eval=FALSE, echo=FALSE}
vicRecov <- vicTests <- NA_real_
vicUrl <- c(
  "https://www.dhhs.vic.gov.au/coronavirus-update-victoria-{format(dt, '%d')}-{format.Date(dt, '%B')}-{year(dt)}",
  "https://www.dhhs.vic.gov.au/coronavirus-update-victoria-{day(dt)}-{format.Date(dt, '%B')}-{year(dt)}",
  "https://www.dhhs.vic.gov.au/coronavirus-update-victoria-{format(dt - 1, '%d')}-{format.Date(dt - 1, '%B')}-{year(dt-1)}",
    "https://www.dhhs.vic.gov.au/coronavirus-update-victoria-{day(dt - 1)}-{format.Date(dt - 1, '%B')}-{year(dt-1)}"
  ) %>% 
  vapply(glue, character(1)) %>%
  str_to_lower() %>%
  vapply(url.exists, logical(1)) %>%
  which() %>%
  names() %>%
  .[[1]] 
vicTxt <- vicUrl %>%
  read_html() %>%
  html_nodes("body") %>% 
  html_text() %>% 
  str_split("\n") %>% 
  .[[1]] %>% 
  str_trim() %>% 
  .[. != ""] %>%
  str_subset("(test|recovered|total|died)") %>% 
  stringi::stri_trans_general("latin-ascii")
vicTests <- vicTxt %>%
  str_subset(".*[0-9]+.*tests") %>%
  .[[1]] %>%
  str_replace_all(
    ".* ([0-9,]+)[^0-9]test(ed|s|ing).+",
    "\\1"
  ) %>%
  str_remove_all(",") %>%
  as.numeric()
vicRecov <- vicTxt %>%
  str_subset("[0-9]+.+recovered") %>%
  str_trim() %>%
  str_replace_all("[^0-9,]*([0-9,]+)[^0-9]*people have recovered.*", "\\1") %>%
  str_remove(",") %>%
  as.numeric() 
latestAU$VIC <- tibble(
  State = "Victoria",
  date = dt,
  confirmed = vicTxt %>%
    str_subset("(coronavirus|total).+cases") %>%
    str_subset("Victoria") %>%
    str_subset("regional", negate = TRUE) %>%
    # str_replace_all(".+[^0-9,]+ ([0-9,]+) cases[^0-9,].+", "\\1") %>%
    str_replace_all(".+total.+ ([0-9,]+).*", "\\1") %>%
    str_remove_all(",") %>%
    as.numeric() %>%
    .[!is.na(.)] %>%
    unique(),
  deaths = vicTxt %>% 
    str_subset("died") %>% 
    str_replace_all(".+[^0-9]([0-9,]+)[^0-9]*people have died.+", "\\1") %>%
    str_remove_all(",") %>% 
    as.numeric() %>%
    unique(),
  recovered = vicRecov,
  tested = vicTests
)
```

```{r altVic}
vicUrl <- "https://covidlive.com.au/vic"
vicBody <- vicUrl %>% 
    read_html() %>% 
    html_nodes("body") 
vicTable <- vicBody %>%
    xml_find_all("//table[contains(@class, 'DAILY-SUMMARY')]") %>% 
    html_table() %>%
    .[[1]] %>% 
    mutate(
        TOTAL = str_remove_all(TOTAL, ",") %>% as.numeric
    )
latestAU$VIC <- tibble(
  State = "Victoria",
  date = dt,
  confirmed = vicTable %>%
      dplyr::filter(COUNT == "Cases") %>%
      pull(TOTAL),
  deaths =  vicTable %>%
      dplyr::filter(COUNT == "Deaths") %>%
      pull(TOTAL),
  recovered =  vicTable %>%
      dplyr::filter(COUNT == "Recoveries") %>%
      pull(TOTAL),
  tested = vicBody %>% 
      xml_find_all("//table[contains(@class, 'DAILY-TESTS')]") %>%
      html_table() %>% 
      .[[1]] %>% 
      mutate(TESTS = str_remove_all(TESTS, ",") %>% as.numeric) %>% 
      pull(TESTS) %>%
      max()
)
```


```{r updateWA, eval=FALSE, echo=FALSE}
waTests <- waRecov <- NA_real_
waMedia <- "https://ww2.health.wa.gov.au/News/Media-releases-listing-page" %>%
  read_html() %>% 
  html_nodes("body") %>% 
  xml_find_all("//a[contains(@title, '19 update')]") %>%
  html_attr("href") %>%
  str_subset("2020$") %>%
  .[[1]] 
waUrl <- glue("https://ww2.health.wa.gov.au{waMedia}")
waTxt <- waUrl %>%
  read_html() %>%
  html_nodes("body") %>%
  html_text() %>%
  str_split("\n") %>%
  .[[1]] %>%
  str_trim() %>%
  .[. != ""] %>%
  stringi::stri_trans_general("latin-ascii") 
waTests <- waTxt %>%
  str_subset("test(s|ed).*performed") %>%
  str_replace_all(".+ ([0-9,]+) COVID.+", "\\1") %>%
  str_remove_all(",") %>%
  as.numeric()
waRecov <- waTxt %>%
  str_subset("recovered") %>%
  str_subset("[0-9]..") %>%
  str_remove_all("COVID-19") %>%
  # str_replace_all("[^0-9]*([0-9]*)[^0-9]*", "\\1") %>%
  str_replace_all(".+ ([0-9,]+) [a-z ]+recovered.+", "\\1") %>%
  as.numeric()
latestAU$WA <- tibble(
  State = "Western Australia",
  date = dt,
  confirmed = waTxt %>% 
    str_subset("(State|Western)") %>% 
    str_subset("total") %>%
    str_subset("recovered", TRUE) %>%
    str_remove_all("COVID.*19") %>% 
    str_replace_all("[^0-9]+([0-9]+)[^0-9]+", "\\1") %>% 
    as.numeric() %>%
    .[!is.na(.)] %>%
    unique(),
  deaths = 9, # Needs to be done manually again
  recovered = waRecov,
  tested = waTests
)
```



```{r altWA}
waUrl <- "https://covidlive.com.au/wa" 
waBody <- waUrl %>% 
    read_html() %>% 
    html_nodes("body") 
waTable <- waBody %>%
    xml_find_all("//table[contains(@class, 'DAILY-SUMMARY')]") %>% 
    html_table() %>%
    .[[1]] %>% 
    mutate(
        TOTAL = str_remove_all(TOTAL, ",") %>% as.numeric
    )
latestAU$WA <- tibble(
  State = "Western Australia",
  date = dt,
  confirmed = waTable %>%
      dplyr::filter(COUNT == "Cases") %>%
      pull(TOTAL),
  deaths =  waTable %>%
      dplyr::filter(COUNT == "Deaths") %>%
      pull(TOTAL),
  recovered =  waTable %>%
      dplyr::filter(COUNT == "Recoveries") %>%
      pull(TOTAL),
  tested = waBody %>% 
      xml_find_all("//table[contains(@class, 'DAILY-TESTS')]") %>%
      html_table() %>% 
      .[[1]] %>% 
      mutate(TESTS = str_remove_all(TESTS, ",") %>% as.numeric) %>% 
      pull(TESTS) %>%
      max()
)
```



```{r updateSA, eval=FALSE, echo = FALSE}
saRecov <- saTests <- NA_real_
saUrl <- "https://www.covid-19.sa.gov.au/home/dashboard"
saTxt <- saUrl  %>%
  read_html() %>%
  xml_find_all("//div[contains(@class, 'accordion__content')]") %>%
  .[[1]] %>%
  html_text() %>%
  str_split("\r\n") %>%
  .[[1]] %>%
  str_trim() %>%
  .[. != ""]
## The dashboard is unreliable so use SA Health press releases as an additional source
## These don't appear until late afternoon, so this is a pain in the arse quite frankly
altSaUrl <- c(
  "https://www.sahealth.sa.gov.au/wps/wcm/connect/public+content/sa+health+internet/about+us/news+and+media/all+media+releases/covid-19+update+{day(dt)}+{format(dt, '%B')}",
  "https://www.sahealth.sa.gov.au/wps/wcm/connect/public+content/sa+health+internet/about+us/news+and+media/all+media+releases/covid-19+update+{day(dt - 1)}+{format(dt - 1, '%B')}",
    "https://www.sahealth.sa.gov.au/wps/wcm/connect/public+content/sa+health+internet/about+us/news+and+media/all+media+releases/covid-19+update+{day(dt)}+{format(dt, '%B')}+2020",
  "https://www.sahealth.sa.gov.au/wps/wcm/connect/public+content/sa+health+internet/about+us/news+and+media/all+media+releases/covid-19+update+{day(dt - 1)}+{format(dt - 1, '%B')}+2020"
  ) %>%
  vapply(glue, character(1)) %>%
  str_to_lower()
validSa <- altSaUrl %>%
  vapply(url.exists, logical(1)) %>% 
  which() %>%
  names() %>%
  sapply(read_html, simplify = FALSE) %>%
  lapply(html_node, css = "body") %>%
  vapply(function(x){!is.na(x)}, logical(1)) %>%
  which() %>%
  names() %>%
  .[[1]]
altSaTxt <- validSa %>%
  read_html() %>%
  html_node("body") %>%
  xml_find_all("//section[@class = 'main-content']") %>%
  html_text() %>%
  str_split("\n") %>%
  .[[1]] %>%
  str_trim() %>%
  .[. != ""]
saTests <- c(
  saTxt %>%
    str_replace_all(".+[^0-9,]([0-9,]+)[^0-9,]+tests.+", "\\1") %>%
    str_remove_all("[, ]") %>%
    as.numeric(),
  altSaTxt %>%
    str_subset("tests") %>%
    str_replace_all(".+ ([0-9,]+) test.+", "\\1") %>%
    str_remove_all(",") %>%
    as.numeric()
) %>%
  max(na.rm = TRUE)
saTable <- "https://www.covid-19.sa.gov.au/" %>% 
  read_html() %>% 
  html_node("body") %>% 
  xml_find_all("//div[@class = 'focus-boxes']") %>%
  html_text() %>% 
  str_split("\r\n") %>% 
  .[[1]] %>% 
  str_trim() %>% 
  .[.!=""] %>% 
  .[seq(length(.), 1, by = -1)] %>% 
  .[!str_detect(., "(Data current|View the|See more)")] %>%
  matrix(ncol = 2, byrow = TRUE) %>% 
  set_colnames(c("Cases", "Total")) %>% 
  as.data.frame(stringsAsFactors = FALSE) %>% 
  mutate(
    Total = as.numeric(Total),
    Cases = str_remove_all(Cases, "in South Australia")
  )
saRecov <- c(
  saTable %>%
    dplyr::filter(str_detect(Cases, "recovered")) %>%
    .[["Total"]],
  altSaTxt %>%
    str_subset("(cleared|recovered)") %>%
    str_replace_all(".+ ([0-9]+) people have.+", "\\1") %>%
    as.numeric()
) %>%
  max(na.rm = TRUE)
latestAU$SA <- tibble(
  State = "South Australia",
  date = dt,
  confirmed = saTable %>% 
    dplyr::filter(str_detect(Cases, "Total cases")) %>% 
    .[["Total"]],
  deaths = 4, # Only able to be added manually. Thanks SA Health
  recovered = saRecov,
  tested = saTests
)
```


```{r altSA}
saUrl <- "https://covidlive.com.au/sa" 
saBody <- saUrl %>% 
    read_html() %>% 
    html_nodes("body") 
saTable <- saBody %>%
    xml_find_all("//table[contains(@class, 'DAILY-SUMMARY')]") %>% 
    html_table() %>%
    .[[1]] %>% 
    mutate(
        TOTAL = str_remove_all(TOTAL, ",") %>% as.numeric
    )
latestAU$SA <- tibble(
  State = "South Australia",
  date = dt,
  confirmed = saTable %>%
      dplyr::filter(COUNT == "Cases") %>%
      pull(TOTAL),
  deaths =  saTable %>%
      dplyr::filter(COUNT == "Deaths") %>%
      pull(TOTAL),
  recovered =  saTable %>%
      dplyr::filter(COUNT == "Recoveries") %>%
      pull(TOTAL),
  tested = saBody %>% 
      xml_find_all("//table[contains(@class, 'DAILY-TESTS')]") %>%
      html_table() %>% 
      .[[1]] %>% 
      mutate(TESTS = str_remove_all(TESTS, ",") %>% as.numeric) %>% 
      pull(TESTS) %>%
      max()
)
```



```{r updateACT}
actRecov <- actTests <- NA_real_
actUrl <- "https://www.covid19.act.gov.au/home"
actTxt <- actUrl %>%
  read_html() %>%
  html_nodes("body") %>%
  xml_find_all(
    "//div[contains(@class, 'spf-article-card--tabular')]"
  ) %>% 
  html_text() %>% 
  str_split("\r\n") %>% 
  .[[1]] %>% 
  str_trim() %>% 
  setdiff(y = "") %>% 
  str_remove_all("[,*]")
actTable <- actTxt[seq(6, length(actTxt))] %>%
  matrix(ncol = 2, byrow = TRUE) %>%
  set_colnames(c("Category", "Total")) %>%
  as_tibble() %>%
  mutate(Total = as.numeric(Total))
actConf <- actTxt %>%
  str_subset("Total") %>% 
  str_remove_all("[A-Za-z ]") %>% 
  as.numeric() 
actTests <- actTable %>% 
  dplyr::filter(str_detect(Category, "Negative test")) %>%
  .[["Total"]] %>%
  sum() %>%
  add(actConf)
actRecov <- actTable %>%
  dplyr::filter(str_detect(Category, "recov")) %>%
  .[["Total"]]
latestAU$ACT <- tibble(
  State = "Australian Capital Territory",
  date = dt,
  confirmed = actConf,
  deaths = 3, # Only able to be added manually.
  recovered = actRecov,
  tested = actTests
)
```




```{r altACT}
actUrl <- "https://covidlive.com.au/act" 
actBody <- actUrl %>% 
    read_html() %>% 
    html_nodes("body") 
actTable <- actBody %>%
    xml_find_all("//table[contains(@class, 'DAILY-SUMMARY')]") %>% 
    html_table() %>%
    .[[1]] %>% 
    mutate(
        TOTAL = str_remove_all(TOTAL, ",") %>% as.numeric
    )
latestAU$ACT <- tibble(
  State = "Australian Capital Territory",
  date = dt,
  confirmed = actTable %>%
      dplyr::filter(COUNT == "Cases") %>%
      pull(TOTAL),
  deaths =  actTable %>%
      dplyr::filter(COUNT == "Deaths") %>%
      pull(TOTAL),
  recovered =  actTable %>%
      dplyr::filter(COUNT == "Recoveries") %>%
      pull(TOTAL),
  tested = actBody %>% 
      xml_find_all("//table[contains(@class, 'DAILY-TESTS')]") %>%
      html_table() %>% 
      .[[1]] %>% 
      mutate(TESTS = str_remove_all(TESTS, ",") %>% as.numeric) %>% 
      pull(TESTS) %>%
      max()
)
```


```{r updateTAS}
tasUrl <- "https://www.coronavirus.tas.gov.au/facts/cases-and-testing-updates"
tasTables <- tasUrl %>%
  read_html() %>%
  html_nodes("body") %>%
  xml_find_all("//table") %>%
  html_table() %>%
  .[1:2] %>%
  lapply(mutate, Number = str_remove_all(Number, "[^0-9]")) %>%
  lapply(mutate, Number  = as.numeric(Number))
latestAU$TAS <- tibble(
  State = "Tasmania",
  date = dt,
  confirmed = dplyr::filter(
     tasTables[[2]], 
     str_detect(`Cases in Tasmania`, "Total cases")
     )$Number,
  deaths = dplyr::filter(
     tasTables[[2]], 
     str_detect(`Cases in Tasmania`, "Deaths")
     )$Number,
  recovered = dplyr::filter(
    tasTables[[2]],
    `Cases in Tasmania` == "Recovered"
    )$Number,
  tested = dplyr::filter(
    tasTables[[1]],
    `Laboratory tests` == "Total laboratory tests"
    )$Number
)
```



```{r updateNT}
ntUrl <- "https://coronavirus.nt.gov.au/current-status"
ntTable <- ntUrl %>% 
  read_html() %>% 
  html_nodes("body") %>%
  xml_find_all("//div[contains(@class, 'covid-card-stats')]") %>% 
  html_text() %>% 
  str_split("\r\n") %>%
  .[[1]] %>% 
  str_trim() %>% 
  .[. != ""] %>%
  matrix(ncol = 2, byrow = TRUE) %>% 
  set_colnames(c("Total", "Category")) %>% 
  as.data.frame() %>% 
  mutate(Total = str_remove_all(Total, ",") %>% as.numeric())
latestAU$NT <- tibble(
  State = "Northern Territory",
  date = dt,
  confirmed = dplyr::filter(ntTable, str_detect(Category, "confirmed"))$Total,
  deaths = 0,
  recovered = dplyr::filter(ntTable, str_detect(Category, "recovered"))$Total,
  tested = dplyr::filter(ntTable, str_detect(Category, "tests"))$Total
)
```


```{r latestAU}
latestAU %<>% 
  bind_rows() %>%
  mutate(Country = "Australia")
```


```{r updateRecovered}
latestAU %>%
  dplyr::select(
    `Province/State` = State, Country, date, recovered
  ) %>%
  write_tsv(
    here::here(glue("recovered/recovered_{dt}.tsv"))
  )
```


```{r updateConfirmed}
confirmed %<>%
  bind_rows(
    dplyr::select(latestAU, any_of(colnames(.)), `Province/State` = State)
  ) %>%
  arrange(date) %>%
  mutate(f = paste(`Province/State`, Country, sep = "_")) %>%
  split(f = .$f) %>%
  lapply(mutate, confirmed = cummax(confirmed)) %>%
  bind_rows() %>%
  dplyr::select(-f) %>%
  arrange(Country, `Province/State`, date, desc(confirmed)) %>%
  dplyr::distinct(`Province/State`, Country, date, .keep_all = TRUE)
```



```{r nswJSON}
# This is 24hrs behind but has the censored values
# We can update the recovered time series from here
# These deaths are more accurate than JHU and the JHU TS should be updated
nswJSON <- "https://nswdac-covid-19-postcode-heatmap.azurewebsites.net/datafiles/data_Cases2.json" %>%
    fromJSON() %>%
    .[["data"]] %>%
    as_tibble() %>%
    separate(Date, into = c("Day", "Month")) %>%
    mutate(
      Date = paste0("2020-", Month, "-", Day) %>% 
        as_datetime(format = "%Y-%b-%d") %>%
        ymd()
    ) %>% 
    group_by(Date) %>%
    summarise(
      confirmed = sum(Cases),
      recovered = sum(Recovered + censored),
      deaths = sum(Deaths)
    ) %>%
    mutate(
      `Province/State` = "New South Wales",
      Country = "Australia"
    ) %>%
    dplyr::rename(date = Date)
```


```{r auRecTS}
auRecTS <- list.files(here::here("recovered"), pattern = "rec.*tsv",full.names = TRUE) %>%
  lapply(read_tsv) %>%
  bind_rows() %>% 
  dplyr::filter(!(date %in% nswJSON$date & `Province/State` == "New South Wales")) %>%
  bind_rows(dplyr::select(nswJSON, any_of(colnames(.)))) %>%
  arrange(`Province/State`, date) %>%
  group_by(`Province/State`) %>%
  mutate(recovered = cummax(recovered))
```


```{r jhuRecovered}
recovered <- url("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_recovered_global.csv") %>%
    read_csv() %>%
    pivot_longer(
        cols = ends_with("20"),
        names_to = "date",
        values_to = "recovered"
    )  %>%
    mutate(
        date = str_replace_all(
            date, "(.+)/(.+)/(.+)", "20\\3-\\1-\\2"
        ) %>%
            ymd()
    ) %>%
    dplyr::rename(
        Country = `Country/Region`
    ) %>%
    dplyr::select(-Lat, -Long) %>%
    dplyr::filter(Country == "Australia") %>%
    bind_rows(auRecTS) %>%
    group_by(
        `Province/State`, Country, date
    ) %>%
    summarise_at(vars(recovered), max)
```


```{r deaths}
deaths <- url("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_global.csv") %>%
    read_csv() %>%
    pivot_longer(
        cols = ends_with("20"),
        names_to = "date",
        values_to = "deaths"
    )  %>%
    mutate(
        date = str_replace_all(
            date, "(.+)/(.+)/(.+)", "20\\3-\\1-\\2"
        ) %>%
            ymd()
    ) %>%
    dplyr::rename(
        Country = `Country/Region`
    ) %>%
    dplyr::filter(Country == "Australia") %>%
    dplyr::select(-Lat, -Long) %>%
    bind_rows(
        dplyr::select(latestAU, any_of(colnames(.)), `Province/State` = State)
    ) %>%
    bind_rows(
        dplyr::select(nswJSON, any_of(colnames(.)))
    ) %>%
    arrange(date) %>%
    mutate(f = paste(`Province/State`, Country, sep = "_")) %>%
    split(f = .$f) %>%
    lapply(mutate, deaths = cummax(deaths)) %>%
    bind_rows() %>%
    dplyr::select(-f) %>%
    dplyr::distinct(`Province/State`, Country, date, .keep_all = TRUE) 
```


Data for confirmed cases, recoveries and fatalities was primarily sourced from [Johns Hopkins University](https://coronavirus.jhu.edu/), using the datasets provided at https://github.com/CSSEGISandData/COVID-19.
JHU data is now updated every 24 hours at approximately 3:30(UTC), which is about 1:00PM in Adelaide.
**As such no accurate, daily updates for international data can be produced until after that time.**
Importantly, dates associated with confirmed cases from this data source, may differ from dates associated with confirmed cases from Australian sources.
For example, cases reported in the morning in Australia may be assigned to the previous day in US data sources.

Live hourly updates for Australia are available from https://covid-19-au.com/ for those who would like an up to the minute breakdown of confirmed cases.
Numbers used for generation of this page are updated periodically throughout the day using values provided by individual states at [NSW](`r nswUrl`), [QLD](`r qldUrl`), [VIC](`r vicUrl`), [WA](`r waUrl`), [SA](`r saUrl`), [TAS](`r tasUrl`), [ACT](`r actUrl`) and the [NT](`r ntUrl`).
Additional Australian data was obtained from [The Guardian](https://interactive.guim.co.uk/docsdata/1q5gdePANXci8enuiS4oHUJxcxC13d6bjMRSicakychE.json).
Whilst dates from the Guardian are likely to be reported using the UK time-zone as a reference, this is still closer to Australian time zones than USA-based data from JHU.

Information on *recovered cases has been difficult to accurately obtain* due inconsistent methods for considering a case as recovered, and lack of reporting for these cases in many jurisdictions.
In Australia, some states (e.g. NSW & QLD) have only begun releasing these figures in mid-April, whilst other states such as Victoria were releasing these numbers from mid-March.

### International Data

International data and figures [can be viewed here](COVID19_Progression.html)


# Latest Australian Data {.tabset}

```{r ausPops}
ausPops <- tribble(
  ~State, ~Population,
  "New South Wales", 	8117976,
  "Victoria", 6629870,
   "Queensland", 5115451,
  "South Australia", 1756494,
  "Western Australia", 2630557,
  "Tasmania", 535500,
  "Northern Territory", 245562,
  "Australian Capital Territory", 428060
)
```

Australian State populations were taken from the [ABS Website](http://stat.data.abs.gov.au/Index.aspx?DataSetCode=ERP_QUARTERLY) and were accurate in Sept 2019.

- It is now clear that Australia is **no longer in an exponential growth phase** and they pandemic may be under control in all states except Victoria.
- The June/July outbreak in Victoria is now **larger than the initial March outbreak**
- Using an estimated population size of `r comma(sum(ausPops$Population))`, the total percentage of the Australian population *confirmed as having been infected* currently sits at `r percent_format(accuracy = 0.01)(sum(latestAU$confirmed) / sum(ausPops$Population))`, or one person in every `r comma(round(sum(ausPops$Population) / sum(latestAU$confirmed), 0))`. 
- Within Victoria, that rises to one in every `r ausPops %>% left_join(latestAU) %>% mutate(r = confirmed / Population, every = 1 / r) %>% dplyr::filter(State == "Victoria") %>% pull(every) %>% round(0)` having contracted the virus at some point
- Notably, the proportion of recovered cases is now >90% in all states except Victoria
- NSW Health made a significant change to their recovered cases on `r format.Date(min(nswJSON$date), "%d, %B %Y")` when **cases not tracked after 6 weeks were classified as recovered**. An additional change was subsequently made such that active cases are now formally classed as locally acquired within the last 4 weeks. This change has not yet been implemented below.


```{r latestAUTable}
confirmed %>% 
  dplyr::filter(
    date >= sort(unique(date), decreasing = TRUE)[2]
  ) %>%
  bind_rows(
    group_by(., date) %>%
      summarise(
        confirmed = sum(confirmed)
      ) %>%
      mutate(
        `Province/State` = "Total"
      )
  ) %>%
  group_by(`Province/State`) %>%
  mutate(
    Increase = c(NA, diff(confirmed)),
    `% Increase` = c(NA, diff(confirmed)) / min(confirmed)
  ) %>%
  ungroup() %>%
  pivot_wider(
    id_cols = `Province/State`, 
    names_from = date, 
    values_from = c(confirmed, Increase, `% Increase`)
  ) %>%
  dplyr::select_if(function(x){sum(is.na(x)) <= 1}) %>%
  rename(State = `Province/State`) %>%
  rename_all(str_remove_all, pattern = "confirmed_") %>%
  rename_all(str_remove_all, pattern = "_2020.+") %>%
  left_join(
    dplyr::select(latestAU, State, confirmed, deaths)
  ) %>%
  mutate_at(
    vars(confirmed, deaths),
    function(x){
      x[is.na(x)] <- sum(x, na.rm = TRUE)
      x
    }
  ) %>%
  left_join(
    auRecTS %>% 
      dplyr::filter(date == dt) %>% 
      dplyr::select(State = `Province/State`, recovered) %>%
      bind_rows(tibble(State = "Total", recovered = sum(.$recovered)))
  ) %>%
  mutate(
    `% Increase` = percent(`% Increase`, accuracy = 0.01),
    `Fatality Rate` = percent(deaths / confirmed, accuracy = 0.1),
    `Recovery Rate` = percent(recovered / confirmed, accuracy = 0.1),
    `Currently Active` = confirmed - recovered - deaths,
  ) %>%
  rename(
    Fatalities = deaths,
    Recovered = recovered
  ) %>%
  dplyr::select(
    State, starts_with("20"), ends_with("Increase"), starts_with("Fatal"), starts_with("Recov"), `Currently Active`
  ) %>%
  pander(
    justify = "lrrrrrrrrr",
    caption = paste(
      "*Confirmed cases, fatalities and recoveries reported by each state at time of preparation.",
      "Any states with unchanged, or decreasing confirmed cases may indicate delays with the automated data sources, such as health.gov.au or JHU, or that these states have not yet reported for the day.", 
      "Please note that some discrepancy with dates may occur due to automated data sources obtained different time zones, such as the USA, the UK and Australia.*"
    ),
    emphasize.strong.rows = nrow(.)
  )
```

## Plot of Current Australian Values

```{r ausStatsCap}
ausStatsCap <- "*Current confirmed and recovered cases, along with fatalities for Australia only. Active cases are shown as confirmed cases excluding fatalities and those classed as recovered. Loess curves through all points are shown as continuous lines. Data is only shown from 1^st^ March 2020 as this was the date of the first recorded fatality in Australia. Recovered patient information was also sparse in the early stages of data collection, and as a result estimates of active infections will be a significant underestimate until 6^th^ April. In particular, QLD only began reporting recovered cases on this date. NSW followed a fortnight after this date and as such, only the most recent numbers can be considered as accurate. Below this plot, the same figures can be seen broken down by state.*"
```

```{r showAusStatsPlot, fig.height=6, fig.width=8, fig.cap=ausStatsCap}
ggplotly(
  confirmed %>%
    left_join(deaths) %>%
    left_join(recovered) %>%
    mutate_at(vars(confirmed, deaths, recovered), na_locf) %>%
    group_by(Country, date) %>%
    summarise_at(vars(confirmed, deaths, recovered), sum) %>%
    ungroup() %>%
    mutate_at(vars(confirmed, deaths, recovered), cummax) %>%
    mutate(active = confirmed - deaths - recovered) %>%
    pivot_longer(
      cols = c(active, confirmed, deaths, recovered),
      names_to = "Status",
      values_to = "Total"
    ) %>%
    arrange(Status, date) %>%
    dplyr::filter(date > ymd("2020-02-29")) %>%
    mutate(
      Status = str_to_title(Status),
      Status = str_replace_all(Status, "Deaths", "Fatal"),
      Status = factor(Status, levels = c("Recovered", "Active", "Fatal"))
    ) %>%
    dplyr::filter(Total > 0) %>%
    rename_all(str_to_title) %>%
    dplyr::filter(Status != "Confirmed") %>%
    ggplot(aes(Date, Total, fill = Status)) +
    geom_col() +
    geom_line(
      data = . %>%
        group_by(Date) %>%
        summarise(
          Total = sum(Total)
        ) %>%
        mutate(Status = "Confirmed"),
      colour = "blue"
    ) +
    scale_fill_manual(
      values = c(
        Active = rgb(0, 0, 0),
        Confirmed = rgb(0, 0.3, 0.7),
        Fatal = rgb(0.8, 0.2, 0.2),
        Recovered = rgb(0.2, 0.7, 0.4)
      )
    ) +
    scale_x_date(expand = expansion(c(0, 0.03))) +
    scale_y_continuous(expand = expansion(c(0, 0.05))) +
    labs("Total Cases")
)
```



```{r plotStates, fig.width=10, fig.height=8, fig.cap="*Breakdown of individual states. Victorian recovered numbers began to be accurately reported from 22^nd^ March, with other states gradually providing this information. NSW/QLD recovered cases have only recently begun being reported and up until the most recent dates, recovered/active values were very approximate for these states. The extreme drop for NSW active cases in early June is a function of the changed reporting strategy implemented by NSW Health.*"}
ggplotly(
  confirmed %>%
    left_join(deaths) %>%
    left_join(recovered) %>%
    mutate_at(vars(confirmed, deaths, recovered), na_locf) %>%
    rename(State = `Province/State`) %>%
    dplyr::filter(
      date > ymd("2020-03-19"),
    ) %>%
    arrange(date) %>%
    group_by(State) %>%
    mutate_at(
      vars(confirmed, recovered, deaths), cummax
    ) %>%
    ungroup() %>%
    left_join(ausPops) %>%
    mutate(active = confirmed - deaths - recovered) %>%
    pivot_longer(
      cols = c(confirmed, deaths, recovered, active),
      names_to = "status",
      values_to = "count"
    ) %>%
    dplyr::filter(
      count > 0,
      !(State %in% c("Queensland", "New South Wales") & status == "recovered" & date < ymd("2020-04-06")),
      !(State %in% c("South Australia") & status == "recovered" & date < ymd("2020-04-01")),    
      !(State %in% c("Tasmania") & status == "recovered" & date < ymd("2020-04-02")),
    ) %>%
    dplyr::filter(status != "confirmed") %>%
    mutate(
      rate = 1e6*count/Population,
      rate = round(rate, 2),
      status = str_replace(status, "deaths", "fatal") %>% str_to_title(),
      status = factor(status, levels = c("Recovered", "Active", "Fatal"))
    ) %>%
    rename_all(str_to_title) %>%
    ggplot(aes(Date, Rate, fill = Status, label = Count)) +
    geom_col() +
    geom_line(
      data = . %>%
        group_by(State, Date) %>%
        summarise(
          Rate = sum(Rate),
          Count = sum(Count)
        ) %>%
        mutate(Status = "Confirmed"),
      colour = "blue"
    ) +
    facet_wrap(~State, ncol = 4) + 
    scale_fill_manual(
      values = c(
        Active = rgb(0, 0, 0),
        Confirmed = rgb(0, 0.3, 0.7),
        Fatal = rgb(0.8, 0.2, 0.2),
        Recovered = rgb(0.2, 0.7, 0.4)
      )
    ) +
    scale_x_date(expand = expansion(c(0, 0.03))) +
    labs(y = "Rate (Cases / Million)")
)
```

## Daily New Cases

```{r plotDailyAusCases, fig.width=10, fig.height=8, fig.cap="*Daily new cases for each state shown against the 7-day average. Days which are above average are highlighted in red.*"}
ggplotly(
  confirmed %>%
    group_by(`Province/State`) %>%
    mutate(daily = c(0, diff(confirmed))) %>%
    ungroup() %>%
    dplyr::filter(confirmed > 0) %>%
    mutate(
      daily = case_when(
        daily < 0 ~ 0,
        daily >= 0 ~ daily
      )
    ) %>%
    bind_rows(
      group_by(., date) %>%
        summarise(daily = sum(daily)) %>%
        ungroup() %>%
        mutate(`Province/State` = "All States")
    ) %>%
    group_by(`Province/State`) %>%
    mutate(
      MA = round(sma(daily, 7), 2),
      `Above Average` = daily > MA
    ) %>%
    dplyr::filter(date > "2020-03-01") %>%
    ggplot(aes(date, daily)) +
    geom_col(
      aes(fill = `Above Average`, colour = `Above Average`),
      data = . %>% dplyr::filter(!is.na(`Above Average`)),
      width = 1/2
    ) +
    geom_line(aes(y = MA), colour = "blue") +
    facet_wrap(~`Province/State`, scales = "free_y") +
    labs(
      x = "Date",
      y = "Daily New Cases",
      fill = "\nAbove\nAverage"
    ) +
    scale_fill_manual(values = c("white", rgb(1, 0.2, 0.2))) +
    scale_colour_manual(values = c("grey50", rgb(1, 0.2, 0.2))),
  tooltip = c(
    "date", "daily", "MA"
    )
)
```


## Current Growth Factor

```{r cap4GF}
n <- 14
cp <- glue(
  "*Growth factor for each State/Territory. 
  This value becomes volatile when daily new cases approach zero as is commonly observed in small populations, and at the end stages of an outbreak. 
  In order to try and minimise volatility a {n} day simple moving average was used, in contrast to the 5 day average as advocated [here](https://www.abc.net.au/news/2020-04-10/coronavirus-data-australia-growth-factor-covid-19/12132478).
  This enables assessment of the growth factor over an entire quarantine period.
  If no new cases are observed over this period, the value is not able to be calculated.
  The dashed vertical lines indicate the day most state borders were closed.*"
)
```


```{r plotGF, fig.width=10, fig.height=8, fig.cap=cp}
gf <- list(
  confirmed %>%
    dplyr::filter(Country == "Australia") %>% #, date < dt) %>%
    arrange(date) %>%
    group_by(
      `Province/State`
    ) %>%
    mutate(
      new = c(0, diff(confirmed)),
      new_ma = sma(new, n)
    ) %>%
    dplyr::filter(confirmed > 0, !is.na(new_ma)) %>%
    mutate(
      R = c(NA, new_ma[-1] / new_ma[-n()]),
      R = case_when(
        is.nan(R) ~ NA_real_,
        !is.nan(R) ~ R
      )
    ) %>%
    ungroup() %>%
    arrange(`Province/State`),
  confirmed %>%
    dplyr::filter(Country == "Australia") %>% #, date < dt) %>%
    arrange(date) %>%
    group_by(Country, date) %>%
    summarise_at(vars(confirmed), sum) %>%
    ungroup() %>%
    mutate(
      new = c(0, diff(confirmed)),
      new_ma = sma(new, n)
    ) %>%
    dplyr::filter(confirmed > 0, !is.na(new_ma)) %>%
    mutate(
      R = c(NA, new_ma[-1] / new_ma[-n()]),
      R = case_when(
        is.nan(R) ~ NA_real_,
        !is.nan(R) ~ R
      ),
      `Province/State` = "All States"
    ) %>%
    arrange(`Province/State`)
) %>%
  bind_rows() %>%
  dplyr::filter(date > ymd("2020-03-15")) %>%
  ggplot(aes(date, R, colour = `Province/State`)) +
  geom_ribbon(aes(ymin = 1, ymax = R), alpha = 0.1) +
  geom_hline(yintercept = 1) +
  geom_vline(
    xintercept = ymd("2020-03-22"),
    linetype = 2,
    colour = "grey30"
  ) +
  geom_label(
    aes(label = R),
    data = . %>%
      dplyr::filter(date == max(date)) %>%
      mutate(R = round(R, 2), date = date + 1),
    fill = rgb(1, 1, 1, 0.3),
    show.legend = FALSE
  ) +
  labs(
    x = "Date", y = "Growth Factor"
  ) +
  facet_wrap(~`Province/State`, scales = "free_x") +
  theme(legend.position = "none") +
  coord_cartesian(ylim = c(0.0, 3))
gf
```

The current `r n` day growth factor is `r round(dplyr::filter(gf$data, date == max(date), confirmed == max(confirmed))$R, 2)` which gives `r ifelse(dplyr::filter(gf$data, date == max(date), confirmed == max(confirmed))$R > 1, "*considerable cause for concern*", "some degree of confidence that the spread of infections is relatively under control")`.
In particular, the **outbreak in Victoria is clearly not under control**.

## Testing Within Each State

```{r updateTested}
latestAU %>%
  dplyr::select(State, Tested = tested) %>%
  write_tsv(
    glue(
      "tested/tested_{format(dt, '%Y%m%d')}.tsv"
    )
  )
```


Testing numbers were initially sourced from manual inspection of individual press releases for [NSW](`r nswUrl`), [QLD](`r qldUrl`), [VIC](`r vicUrl`), [WA](`r waUrl`), [SA](`r saUrl`), [TAS](`r tasUrl`), [ACT](`r actUrl`) and the [NT](`r ntUrl`).
Updates on testing numbers beyond the initial values were performed automatically using the above code which probes each state's official releases for the latest values, and updates where found.
The number of tested individuals in each state was then assessed as a function of State population size.
All results are valid at the time of report generation.

```{r propTest}
latestAU %>%
  dplyr::select(State, Tested = tested) %>%
  full_join(
    confirmed %>%
      dplyr::filter(
        date == dt,
        Country == "Australia"
      ) %>%
      rename(
        State = `Province/State`
      ) 
  ) %>%
  mutate(
    Tested = case_when(
      is.na(Tested) ~ confirmed,
      Tested < confirmed ~ confirmed,
      !is.na(Tested) ~ Tested
    )
  ) %>%
  left_join(ausPops) %>%
  bind_rows(
    tibble(
      State = "Total",
      Population = sum(.$Population, na.rm = TRUE),
      confirmed = sum(.$confirmed, na.rm = TRUE),
      Tested = sum(.$Tested, na.rm = TRUE)
    )
  ) %>%
  mutate(
    `Tests / '000` = round(1e3 * Tested / Population, 2),
    Positive = confirmed / Tested,
    Negative = 1 - Positive,
    isTotal = grepl("Total", State)
  ) %>%
  dplyr::select(
    State, Population,
    Confirmed = confirmed,
    Tested, 
    contains("000"), 
    ends_with("ive"),
    isTotal
  ) %>%
  arrange(isTotal, desc(`Tests / '000`)) %>%
  dplyr::select(-isTotal) %>%
  dplyr::rename(
    `% Positive Tests` = Positive,
    `% Negative Tests` = Negative
  ) %>%
  mutate_at(
    vars(starts_with("%")), percent, accuracy = 0.01
  ) %>%
  pander(
    justify = "lrrrrrr",
    missing = "",
    caption = glue(
      "*COVID-19 testing scaled by state population size.
      Confirmed cases are assumed to be the tests returning a positive result.
      The current numbers available for some states are a lower limit, and as such, the proportion of the population tested is likely to be higher, as is the proportion of tests returning a negative result.*"
    ),
    emphasize.strong.rows = nrow(.)
  )
```



# R Session Information

```{r sessionInfo, echo=FALSE}
pander(sessionInfo())
```

